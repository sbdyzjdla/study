# 자바 동시성이슈 해결방법

### 왜 테스트가 실패하는지?

스레드1이 재고가 100일때 접근, 스레드2도 재고가 100일때 접근
스레드1이 재고를 하나줄임, 스레드2도 재고가 100일때 재고를 하나줄임

** Race Condition **
두개 이상의 스레드가 공유 자원에 접근할수있고 동시에 변경하려고 할때 발생하는문제
해결방법은 데이터에 한개의 스레드만 접근가능하게 해야함

1. ### 자바에서의 해결방법 synchronized 사용

   그러다 @Transactional의 동작과정때문에 주석처리하고 사용해야함
   synchronized일때 문제점은 서버가 2개이상일경우 -> 그러나 보통의 서비스는 서버2개이상으로 구성되있음
2. ### mysql 이용

* Pessimistic Lock

  * 실제로 데이터에 락을 걸어서 정합성을 맞추는 방법
  * exclusive lock을 걸게되면 다른 트랙잭션에서 락이 해제되기 전까지 데이터를 가져갈수없음
  * 그러나 데드락이 걸릴수도 있음
* Optimistic Lock

  * 실제 락을 사용하지않고 버전을 이용해 정합성을 맞추는 방법
  * 업데이트전 버전을 확인한후 업데이트를 진행, 현재 내가 읽은 버전에서 수정사항이 생겼을 경우 다시 읽은후 작업을 수행하도록해야함
  * 충돌이 빈번하게 일어날때 속도가 느림
* Named Lock

  * 이름을 가진 메타데이터 락킹
  * 이름을 가진 락을 획득후 해제할때까지 다른 세션은 이 락을 획득할수 없도록함
  * 트랜잭션이 종료될때 락이 자동으로 해제되지않아 별도의 명령어로 해제해야 선점기간이 끝나고 해제됨
  * Pessimistic가 데이터에 직접 락을 걸었다면 Named락은 별도의 공간에 락을검

3. ### Redis 이용

* 분산락을 사용할때 쓰는 라이브러리 Lettuce vs Redisson 비교

  * Lettuce
    * setnx 명령어로 분산락 구현
    * spin lock 방식 (다른 스레드가 락을 소유하고있으면 그 락이 반환될때까지 계속 확인하며 기다리는것, retry 필요함)
    * NamedLock과 비슷, redis를 쓴다, 세션관리를 신경쓰지않아도 된다 정도의 차이
  * Redisson
    * pub-sub 기반으로 락 구현 (별도의 retry 로직 구현하지 않아도됨) Thread1 이 channel에 끝났다고(락해제) 말해주고 채널은 Thread2 에게 락획득을 시도하라고함
    * 별도의 라이브러리 필요함
* 실무에서 사용

  * 재시도가 필요하지않은 lock은 lettuce
  * 재시도가 필요한 경우는 redisson

4. ### Mysql, Redis 비교

   * Mysql은 사용하고 있다면 별도의 구축비용이 필요없고, 어느정도의 트래픽까지 활용가능하지만 redis보다 성능이 좋지않다.
   * Redis가 구축되어있지만 않다면 관리비용이 들지만 성능이 좋다
